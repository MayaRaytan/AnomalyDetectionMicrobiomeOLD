import math
import numpy as np
import pandas as pd
from sklearn.decomposition import PCA
import matplotlib as plt
import random
import sklearn
#from skbio import DistanceMatrix ####relative abundance / bray curtis
#from skbio.stats.ordination import pcoa #####pca
#from skbio.diversity import beta_diversity
#import seaborn as sns


class Tree_Node:
    def __init__(self, depth=0, left=None, right=None, split_att=None, split_val=None, size=0, samples=[]):
        self.depth = depth
        self.left = left
        self.right = right
        self.split_att = split_att
        self.split_val = split_val
        self.size = size
        self.samples = samples

'''omriTree is represented by it's root (treeNode type)'''
class Forest:
    def __init__(self, number_of_trees, trees=[]):
        self.number_of_trees = number_of_trees
        self.trees = trees

    '''
        inputs: X=input data, t=number of trees, psi=sub sampling size, l=height limit
        function: Creates forest of omriTrees.
        output: an omriForest
    '''
    def fit(self, X, OTUs, psi, l, t=100, distance_matrix="de_brui"):
        for i in range(t):
            self.trees.append(omri_tree(X, OTUs, 0, l, psi, distance_matrix))
            self.numberOfTrees += 1

'''
    inputs: X=input data, OTUs=taxa, e=current tree height, l=height limit, psi=sub sampling size, distance_matrix = chosen function to calcukate distance matrix
    function:
    output: an omriTree represented by it's root (treeNode type)
'''
def omri_tree(X, OTUs, e, l, psi, distance_matrix):
    np.random.seed(0)
    if e >= l or len(X) <= 1:
        return Tree_Node(depth=e, size=len(X), samples=X.columns)

    else:
        print("hi")
        sampled_X = X.sample(n=psi, random_state=2)
        renormalized_X = relative_abundence(sampled_X)
        #ids = [OTUs[i] for i in sampled_X.index] #####??????????
        #print(ids)
        distance_mat = renormalized_X
        distance_mat.head()
        #distance_mat = beta_diversity(distance_matrix, renormalized_X, ids)

        #pc1 = pcoa(distance_mat).samples[['PC1']] ####????? extract 1st pcoa
        pc1 = PCA().fit(distance_mat).components_[0]
        t = np.random.choice(min(pc1), max(pc1) + 1)
        left = sampled_X[sampled_X[:] < t]
        right = sampled_X[sampled_X[:] > t]
        return Tree_Node(depth=e+1, left=left, right=right, split_att=pc1, split_val=t, size=len(sampled_X.columns), samples=X.columns)


def distance_matrix():
    return


def average_depth(sample, OF):
    d = 0
    for tree in OF.trees:
        position = tree_position(sample, tree)
        d += position.depth
    d /= OF.trees.number_of_trees

def tree_position(sample, tree):
    node = tree
    while node:
        if sample in node.samples:
            if sample in node.left.samples:
                node = node.left
            elif sample in node.right.samples:
                node = node.right
            else:
                position = node
    return position


'''
    inputs: A= a group of anomaly samples (A in X), B= a group of normal samples (A in X), OF= omri forest
    function:
    output: True or False
'''
def test_a_sample(A, B, OF):
    return

def create_data(data):
    data, OTUs = filter_data(data)
    data = relative_abundence(data)
    return data, OTUs

def filter_data(data):
    filtered_data_with_OTUs = data.loc[:, data.sum() > 3000]
    filtered_data = filtered_data_with_OTUs.iloc[:, 1:]
    OTUs = filtered_data_with_OTUs.iloc[:, :1]
    return filtered_data, OTUs

def relative_abundence(data):
    final_data = data.copy()
    for colname in data.columns:
        final_data.loc[:, colname] = data[colname] / sum(data[colname])
    final_data.head()
    return final_data

metadata = pd.read_csv("C:\Maya\CS\AnomalyDetectionMicrobiome\Human_Microbiome_Project_1_6_2017_metadata.tab",sep='\t')
data = pd.read_csv("C:\Maya\CS\AnomalyDetectionMicrobiome\Human_Microbiome_Project_1_6_2017_data.tab",sep='\t')
X, OTUs = create_data(data)

print(omri_tree(X, OTUs, 1, 3, 10, "braycurtis").size)
#omri_tree(X, OTUs, 1, 3, 10, "weighted_unifrac")

def all_body_sites_except_of_feces(metadata):
    all_body_sites = metadata[metadata['body_site'] != 'UBERON:feces']['body_site'].drop_duplicates()
    return all_body_sites


isolation_forest_auc_list = [[0.5783208020050125, 0.6294714057871953, 0.6302688539530643, 0.6134085213032582, 0.61369332421964, 0.6209273182957394, 0.5541410344041923, 0.5239519252677147, 0.6011050353155617, 0.6261107313738893, 0.5618022328548645, 0.5706311232627022, 0.7018683071314651, 0.56940647072226, 0.5529733424470266, 0.7162793347003873, 0.5990544543176122, 0.5274265208475735, 0.5669002050580998, 0.5980291638186375, 0.6132946001367054, 0.619958988380041, 0.6467874231032126, 0.6439393939393939, 0.6623661426293006, 0.5397015265436318, 0.5879756208703577, 0.6143198906356802, 0.537593984962406, 0.5918204602415129, 0.654021417179312, 0.6121553884711779, 0.5644224196855776, 0.6309523809523809, 0.6279334700387331, 0.6501480975165186, 0.6829573934837093, 0.507177033492823, 0.4242709045340624, 0.6688311688311688, 0.666097060833903, 0.5186261107313739, 0.6060036454773297, 0.5819662793347004, 0.5937856003645477, 0.5941558441558442, 0.5652768284347232, 0.6042378673957621, 0.6561289587605377, 0.6211266803372066], [0.1066302118933698, 0.15006265664160404, 0.0944691273638642, 0.08515607199817726, 0.14835383914331282, 0.1640749601275917, 0.14661654135338348, 0.07983025746183643, 0.10563340168603327, 0.06635907951697426, 0.10600364547732971, 0.1331738437001595, 0.09936773752563227, 0.10275689223057645, 0.13385737069947595, 0.15578719526087947, 0.10247208931419458, 0.17825814536340853, 0.11397812713602189, 0.08564023695602643, 0.13687628161312373, 0.13847117794486216, 0.053941672362725006, 0.12109820004556847, 0.16307814992025516, 0.15026201868307132, 0.10124743677375256, 0.10554796081111871, 0.14177489177489175, 0.06596035543403965, 0.10748462064251538, 0.15937571200729095, 0.06613123718386876, 0.12121212121212124, 0.10426634768740031, 0.1095352016404648, 0.13610731373889268, 0.12047163362952838, 0.1496924128503076, 0.12138300296195033, 0.08669400774663934, 0.10697197539302804, 0.15829346092503987, 0.10235816814764184, 0.07060264297106403, 0.10529163818637502, 0.11130097972203236, 0.16752107541581227, 0.16205285942128048, 0.08037138300296195], [0.5354294827979038, 0.5112212349054455, 0.546764638869902, 0.3885281385281386, 0.5697767145135566, 0.457222601959444, 0.3522442469810891, 0.3833447254499886, 0.485930735930736, 0.5086010480747323, 0.5264866712235133, 0.3841991341991342, 0.543233082706767, 0.5285372522214626, 0.5098541809068124, 0.46758942811574394, 0.5294486215538847, 0.4598997493734336, 0.5146388699020278, 0.5459102301207565, 0.4943039416723627, 0.4346662109820005, 0.422989291410344, 0.3771929824561403, 0.5906812485759854, 0.43375484164957856, 0.3457507404875826, 0.5250056960583277, 0.4297676008202324, 0.5521758942811574, 0.37844611528822053, 0.6488380041011621, 0.49720893141945777, 0.5283094098883572, 0.4880952380952381, 0.49504442925495556, 0.4289131920710868, 0.429254955570745, 0.527511961722488, 0.31823877876509454, 0.46160856687172475, 0.39194577352472093, 0.4355775803144224, 0.5734221918432445, 0.5630553656869446, 0.5668147641831852, 0.43711551606288446, 0.4348940533151059, 0.5199931647300068, 0.4190590111642743], [0.25313283208020054, 0.2832934609250399, 0.2896445659603555, 0.250911369332422, 0.3293460925039872, 0.2780246069719754, 0.24877534745955798, 0.2602813852813853, 0.28252449305080884, 0.3617281840966051, 0.29625199362041466, 0.24025974025974028, 0.3397983595352017, 0.31647300068352696, 0.30063795853269537, 0.301492367281841, 0.2813852813852814, 0.3203463203463204, 0.19076099339257235, 0.25353155616313516, 0.29579630895420367, 0.20821941216678058, 0.22274436090225563, 0.25945545682387783, 0.26253132832080206, 0.3677660059239007, 0.27321143768512185, 0.3002677147413989, 0.20055821371610846, 0.2844611528822055, 0.23650034176349966, 0.21892800182273867, 0.19574504442925497, 0.2642401458190932, 0.3200615174299385, 0.19762474367737526, 0.2575187969924812, 0.2654647983595352, 0.24216791979949878, 0.2218045112781955, 0.23957621326042375, 0.2602813852813853, 0.34529505582137154, 0.3929710640236957, 0.2589712918660287, 0.24071542492595124, 0.22761449077238552, 0.2923786739576214, 0.14809751651856914, 0.35440874914559134], [0.5431191615402142, 0.5984848484848484, 0.5651629072681704, 0.536825017088175, 0.4389952153110048, 0.5619161540214173, 0.46348826611984506, 0.5415242652084757, 0.5813397129186603, 0.5383344725449989, 0.45807701070858964, 0.49720893141945777, 0.44543176122123485, 0.5202779676463887, 0.5802574618364092, 0.42367281840966053, 0.45101389838231937, 0.5103098655730235, 0.581453634085213, 0.5055821371610846, 0.5356573251310093, 0.5706311232627022, 0.5389610389610389, 0.4370585554796081, 0.4915698336750968, 0.5712861699703806, 0.6326042378673957, 0.6306675780359992, 0.5101105035315562, 0.45215311004784686, 0.4952153110047846, 0.442697653223969, 0.5484164957849168, 0.5758714969241285, 0.42976760082023246, 0.6255980861244019, 0.6385850991114149, 0.4322738664843928, 0.5234677603098655, 0.5086010480747323, 0.6618250170881751, 0.4169514695830486, 0.5824219640009113, 0.5363123718386876, 0.6017316017316017, 0.6198450672134882, 0.49846206425153794, 0.6536226930963772, 0.5793460925039873, 0.5911938938254728], [0.5943836864889496, 0.6168261562998405, 0.6519708361813625, 0.5259170653907496, 0.6408635224424699, 0.5709728867623605, 0.6014467988152199, 0.5727956254272044, 0.6917862838915471, 0.6528822055137845, 0.5841877420824789, 0.5439166097060835, 0.5783777625882889, 0.6748689906584643, 0.5944406470722261, 0.6283321941216677, 0.7168489405331511, 0.6210412394622921, 0.5757006151742994, 0.592276144907724, 0.5667008430166324, 0.6467874231032125, 0.47818409660514927, 0.5672704488493963, 0.7042036910457964, 0.667350193665983, 0.6191615402141718, 0.49934495329232176, 0.6069719753930279, 0.4853611300979722, 0.5616883116883118, 0.7267600820232399, 0.49988607883344727, 0.5951811346548188, 0.5977443609022557, 0.5789473684210527, 0.5675552517657781, 0.5734221918432444, 0.4730006835269993, 0.6811346548188654, 0.6170539986329461, 0.6880838459785829, 0.5693210298473458, 0.6161426293005241, 0.631578947368421, 0.7180451127819549, 0.6739576213260423, 0.6224652540442014, 0.6967418546365916, 0.7010138983823194], [0.6157439052175895, 0.7031784005468217, 0.5853839143312827, 0.7118364092048303, 0.5419799498746867, 0.6722488038277512, 0.5578149920255183, 0.6296992481203008, 0.5176577808156756, 0.6633059922533607, 0.6441672362724994, 0.6425723399407609, 0.5747322852586011, 0.6060036454773298, 0.6061745272271589, 0.5737069947596264, 0.6768626110731374, 0.634028252449305, 0.7339940760993392, 0.6053201184780131, 0.5942128047391205, 0.41820460241512875, 0.5350877192982456, 0.6058327637275005, 0.602529049897471, 0.6367053998632946, 0.5658464342674869, 0.6596605149236727, 0.6070858965595808, 0.7325700615174299, 0.633401686033265, 0.5603212576896788, 0.5725108225108225, 0.4700387331966279, 0.6731601731601732, 0.5416381863750286, 0.49082934609250406, 0.5677261335156072, 0.5123604465709729, 0.6985076327181591, 0.6932672590567328, 0.5573593073593075, 0.48986101617680566, 0.5751310093415356, 0.628673957621326, 0.49054454317612206, 0.5169742538163591, 0.7355320118478014, 0.6679767600820233, 0.568295739348371], [0.6008771929824561, 0.5886876281613124, 0.5967760309865574, 0.47003873319662787, 0.4339542036910458, 0.4776144907723855, 0.5095693779904306, 0.7141148325358851, 0.4301093643198906, 0.6804511278195489, 0.561574390521759, 0.5222146274777854, 0.555622009569378, 0.6371041239462292, 0.6327466393255867, 0.5965481886534518, 0.5019936204146731, 0.6729038505354296, 0.5228411938938254, 0.43067897015265433, 0.4496468443836865, 0.5956937799043062, 0.5287650945545682, 0.5607769423558897, 0.4750512645249487, 0.5069776714513556, 0.37380382775119614, 0.5317270448849396, 0.4801777170198223, 0.5006265664160401, 0.7322282980177717, 0.6888812941444521, 0.5596946912736387, 0.5195374800637959, 0.5019366598313967, 0.5587833219412167, 0.5135566188197768, 0.49700956937799046, 0.5915356573251309, 0.6787423103212576, 0.5522898154477103, 0.5337206652996127, 0.5976874003189793, 0.5653337890179996, 0.6216678058783323, 0.4996582365003418, 0.6021303258145364, 0.5668717247664616, 0.6098200045568467, 0.6195602642971064], [0.17805878332194122, 0.10982000455684666, 0.14103440419229896, 0.07245386192754613, 0.2506835269993165, 0.17737525632262477, 0.188112326270221, 0.14869560264297108, 0.11944634313055368, 0.1467304625199362, 0.14946457051720208, 0.10007974481658694, 0.15031897926634769, 0.13411369332421963, 0.1695716564137617, 0.11964570517202097, 0.12075643654591026, 0.15111642743221693, 0.19064707222601962, 0.1776600592390066, 0.16678058783321942, 0.1887958532695375, 0.12075643654591026, 0.1627648667122351, 0.12092731829573936, 0.12371838687628162, 0.1279334700387332, 0.20135566188197768, 0.19953292321713373, 0.15043290043290045, 0.10982000455684666, 0.15983139667350194, 0.1290157211209843, 0.11836409204830257, 0.10532011847801323, 0.12685121895648213, 0.11409204830257462, 0.2296081111870586, 0.15817953975848714, 0.1651002506265664, 0.2197539302802461, 0.11967418546365914, 0.09845636819321031, 0.15903394850763272, 0.18515037593984962, 0.24419002050580998, 0.12377534745955798, 0.16518569150148094, 0.12679425837320574, 0.18674527227158805], [0.5278537252221464, 0.5739348370927317, 0.5735361130097971, 0.445289359763044, 0.5928457507404876, 0.5571884256094782, 0.4469127363864206, 0.5923615857826384, 0.4550011392116655, 0.6119845067213489, 0.5235816814764183, 0.5944976076555024, 0.509626338573707, 0.6589769879243563, 0.5248917748917749, 0.5521189336978811, 0.4821713374344953, 0.5494417862838916, 0.5112781954887219, 0.6791979949874686, 0.5218728639781272, 0.5213032581453634, 0.6494076099339258, 0.5262588288904079, 0.5330940988835726, 0.4914559125085441, 0.558669400774664, 0.5686944634313055, 0.5747322852586011, 0.5448279790385054, 0.6671223513328777, 0.5918774208247892, 0.6371610845295055, 0.5911369332421964, 0.48046251993620415, 0.41421736158578265, 0.4675324675324675, 0.48934837092731837, 0.49760765550239233, 0.4702665755297334, 0.5583845978582821, 0.5826498063340169, 0.5641945773524721, 0.6375598086124402, 0.5189109136477558, 0.6006493506493507, 0.6295283663704716, 0.47755753018910907, 0.7008999772157667, 0.5479608111187059], [0.36010480747322854, 0.48860788334472544, 0.5350592390066075, 0.3168147641831852, 0.431989063568011, 0.32424812030075184, 0.38664843928001824, 0.3403679653679654, 0.4554568238778765, 0.33988380041011623, 0.3226817042606517, 0.36101617680565046, 0.39678742310321263, 0.43079289131920717, 0.35594668489405334, 0.35252904989747097, 0.3628389154704945, 0.31265664160401, 0.35979152426520844, 0.3685064935064935, 0.3262132604237868, 0.4209387104123946, 0.3258145363408521, 0.29206539074960125, 0.38804397357028936, 0.35574732285258603, 0.3562314878104352, 0.29536910457963095, 0.37924356345408977, 0.409688995215311, 0.31732740943267257, 0.3984392800182274, 0.40960355434039647, 0.5925039872408293, 0.36654135338345867, 0.25996810207336524, 0.3274094326725906, 0.33629528366370476, 0.37756322624743677, 0.2496582365003418, 0.3953064479380269, 0.30285942128047394, 0.3507632718159034, 0.4552005012531328, 0.3490259740259741, 0.47300068352699937, 0.389211665527455, 0.38972431077694236, 0.375768967874231, 0.3402825244930508], [0.23471986417657048, 0.3239697484179658, 0.32751967896280293, 0.28002006482481867, 0.2904769254514586, 0.39527704892730364, 0.28164068529093994, 0.2408550702268869, 0.31629109430467667, 0.25212224108658743, 0.3681123630189844, 0.270566445439111, 0.27585275505479245, 0.4209754591757988, 0.3642151566599784, 0.3594690538663374, 0.4756135206050316, 0.25872048155579563, 0.3095770952307455, 0.33670319493749035, 0.3427226423830838, 0.34233678036734067, 0.30525544065442195, 0.2742321345886711, 0.18563821577403922, 0.43343880228430315, 0.36911560425991663, 0.30741626794258375, 0.37582960333384785, 0.4159592529711375, 0.21824355610433713, 0.1866028708133971, 0.38154036116684675, 0.32057416267942584, 0.3404074702886248, 0.3391727118382466, 0.39921284148788394, 0.3148248186448526, 0.37004167309770025, 0.35302515820342645, 0.3882543602407779, 0.3754437413181047, 0.3745176724803211, 0.36726346658434944, 0.39365642846118226, 0.2746951690075629, 0.27731903071461644, 0.25096465503935794, 0.2567525852755055, 0.3417194011421516], [0.5656185919343815, 0.4628616997038049, 0.6535087719298247, 0.5142401458190932, 0.4537764866712235, 0.599168375484165, 0.6424584187742082, 0.6263955342902711, 0.5516062884483937, 0.6425153793574846, 0.6421736158578264, 0.7416267942583731, 0.5712007290954659, 0.39673046251993616, 0.711038961038961, 0.6585213032581453, 0.5514354066985646, 0.5847573479152427, 0.6240031897926634, 0.48080428343586235, 0.5780929596719069, 0.4566529961266803, 0.5461380724538619, 0.4660514923672819, 0.5763841421736159, 0.5926748689906585, 0.5763841421736158, 0.5234107997265892, 0.5951811346548189, 0.5233538391433128, 0.4448621553884712, 0.5836750968329916, 0.588915470494418, 0.6618250170881749, 0.6061175666438825, 0.628673957621326, 0.5607199817726134, 0.566928685349738, 0.5868364092048303, 0.5425495557074506, 0.5369104579630894, 0.48094668489405323, 0.5082592845750741, 0.7312030075187971, 0.5436887673729779, 0.5446570972886762, 0.6346548188653452, 0.701412622465254, 0.6391547049441787, 0.6522556390977443], [0.04123946229209388, 0.041068580542264754, 0.12383230804283436, 0.12289245841877422, 0.0773524720893142, 0.03765094554568239, 0.04722032353611301, 0.06111870585554796, 0.08680792891319208, 0.08544087491455912, 0.05425495557074504, 0.14519252677147415, 0.053713830029619505, 0.1022442469810891, 0.07370699475962635, 0.07444748234221918, 0.07105832763727501, 0.06308384597858283, 0.12115516062884484, 0.09079516974253816, 0.06447938026885396, 0.08418774208247892, 0.10483595352016405, 0.10076327181590339, 0.050751879699248124, 0.08341877420824789, 0.08749145591250855, 0.08071314650262021, 0.07792207792207793, 0.11568694463431306, 0.11107313738892687, 0.07262474367737526, 0.08695033037138301, 0.12593984962406016, 0.07911825017088175, 0.0917634996582365, 0.07635566188197766, 0.12642401458190933, 0.10597516518569151, 0.050096832991569834, 0.06721348826611986, 0.05758714969241285, 0.07293802688539532, 0.11637047163362954, 0.06801093643198908, 0.05445431761221235, 0.0524606971975393, 0.09580770107085897, 0.10053542948279791, 0.07179881521986786], [0.4092902711323764, 0.344127363864206, 0.2907268170426065, 0.3845978582820688, 0.45277967646388706, 0.36198450672134874, 0.4888072453861928, 0.3793859649122806, 0.35828206880838465, 0.406641604010025, 0.3327922077922078, 0.3094098883572568, 0.3508771929824561, 0.36916154021417175, 0.356516290726817, 0.3784461152882206, 0.4073820915926179, 0.28833447254499883, 0.3585953520164047, 0.25871496924128506, 0.3421622237411711, 0.41831852358168153, 0.32866256550467077, 0.5093415356573251, 0.3364092048302575, 0.4202836637047163, 0.4215652768284347, 0.40521758942811575, 0.2594554568238779, 0.3688482570061517, 0.3708418774208248, 0.3650318979266348, 0.4078947368421052, 0.3284347231715653, 0.44207108680792895, 0.356516290726817, 0.38784461152882205, 0.4368307131465026, 0.2838915470494418, 0.3440419229892915, 0.3839143312827523, 0.46394395078605605, 0.3937685121895648, 0.3881863750284803, 0.28058783321941216, 0.3823763955342903, 0.3076441102756892, 0.4162109820004557, 0.29158122579175216, 0.4551720209614946], [0.7750056960583277, 0.7627022100706312, 0.5477899293688767, 0.6263385737069949, 0.7054568238778764, 0.7323991797676008, 0.7063681932102985, 0.6464456596035544, 0.6355092276144907, 0.6377876509455457, 0.678343586238323, 0.699134199134199, 0.6255411255411256, 0.8205172020961494, 0.6536226930963773, 0.7076213260423787, 0.7159945317840055, 0.7060264297106401, 0.7676577808156756, 0.7345067213488266, 0.6728753702437913, 0.6860332649806333, 0.6210982000455685, 0.7659489633173843, 0.5715424925951241, 0.6191615402141718, 0.5813966735019367, 0.6897357028935976, 0.7177033492822966, 0.6442241968557758, 0.7838915470494418, 0.5852130325814536, 0.7603098655730234, 0.6333447254499888, 0.5412109820004557, 0.6234905445431762, 0.6580086580086579, 0.7272157666894509, 0.6937229437229439, 0.618705855547961, 0.6944634313055366, 0.6981658692185007, 0.6245727956254273, 0.5938140806561859, 0.6605718842560949, 0.5840738209159262, 0.6846092503987242, 0.6719640009113693, 0.5753588516746412, 0.775518341307815]]
all_body_sites = all_body_sites_except_of_feces(metadata)

def graph_auc(isolation_forest_auc_list, all_body_sites):
    return
    #sns.boxplot(data=df, x="age", y="class", hue="alive")
